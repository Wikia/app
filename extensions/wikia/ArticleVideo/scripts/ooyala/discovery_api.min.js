OO.plugin("DiscoveryApi",function(e,t,n,r){var i=20;e.EVENTS.DISCOVERY_API={RELATED_VIDEOS_FETCHED:"relatedVideosFetched",SEND_DISPLAY_EVENT:"sendDisplayEvent",DISPLAY_EVENT_SUCCESS:"displayEventSuccess",SEND_CLICK_EVENT:"sendClickEvent",CLICK_EVENT_SUCCESS:"clickEventSuccess",DISPLAY_EVENT_ERROR:"displayEventError",CLICK_EVENT_ERROR:"clickEventError"};var s=[];e.exposeStaticApi("EVENTS",e.EVENTS);var o=function(t,n){if(!e.requiredInEnvironment("html5-playback"))return;this.id=n,this.mb=t,this.error=!1,this.relatedVideos=[],this.guid="",this.apiHost=e.playerParams.backlot_api_write_server||"api.ooyala.com",e.StateMachine.create({initial:"Init",messageBus:this.mb,moduleName:"DiscoveryApi",target:this,events:[{name:e.EVENTS.EMBED_CODE_CHANGED,from:"*"},{name:e.EVENTS.ASSET_CHANGED,from:"*"},{name:e.EVENTS.ASSET_UPDATED,from:"*"},{name:e.EVENTS.DISCOVERY_API.SEND_DISPLAY_EVENT,from:"*"},{name:e.EVENTS.DISCOVERY_API.SEND_CLICK_EVENT,from:"*"},{name:e.EVENTS.GUID_SET,from:"*"}]})};return t.extend(o.prototype,{onEmbedCodeChanged:function(e,n){s=t.filter(s,function(e){return e!=n}),s.push(n),s.length>=i&&s.shift();if(this.guid===""){var r=t.bind(function(){this._fetchRelatedVideos(n)},this);setTimeout(r,500)}else this._fetchRelatedVideos(n)},onAssetUpdated:function(e,t){this._setRelatedMedia(t)},onAssetChanged:function(e,t){this._setRelatedMedia(t)},_setRelatedMedia:function(t){t.relatedVideos&&(this.relatedVideos=t.relatedVideos,this.mb.publish(e.EVENTS.DISCOVERY_API.RELATED_VIDEOS_FETCHED,{videos:this.relatedVideos}))},onGuidSet:function(e,t){this.guid=t},onSendDisplayEvent:function(r,i){if(!i)return;var s=i.relatedVideos;if(!s||!t.isArray(s)||t.size(s)<1)return;var o=s[0].bucket_info;if(!o)return;if(o.charAt(0)=="2"){this.mb.publish(e.EVENTS.REPORT_DISCOVERY_IMPRESSION,i);return}i={bucket_info:o,custom:i.custom};var u="http://"+this.apiHost+"/v2/discover/feedback/impression";i.device_id=this.guid,i.discovery_profile_id=e.playerParams.playerBrandingId,i.system="OOYALA",n.ajax({url:u,data:JSON.stringify(i),type:"POST",dataType:"json",crossDomain:!0,cache:!0,success:t.bind(this._displayEventSuccess,this),error:t.bind(this._displayEventError,this)})},_displayEventSuccess:function(){this.mb.publish(e.EVENTS.DISCOVERY_API.DISPLAY_EVENT_SUCCESS)},_displayEventError:function(t,n,r){this.mb.publish(e.EVENTS.DISCOVERY_API.DISPLAY_EVENT_ERROR,{xhr:t,status:n,error:r})},onSendClickEvent:function(r,i){if(!i)return;var s=i.clickedVideo;if(!s)return;var o=s.bucket_info;if(!o)return;if(o.charAt(0)=="2"){this.mb.publish(e.EVENTS.REPORT_DISCOVERY_CLICK,i);return}i={bucket_info:o,custom:i.custom};var u="http://"+this.apiHost+"/v2/discover/feedback/play";i.device_id=this.guid,i.discovery_profile_id=e.playerParams.playerBrandingId,i.system="OOYALA",n.ajax({url:u,data:JSON.stringify(i),type:"POST",dataType:"json",crossDomain:!0,cache:!0,success:t.bind(this._clickEventSuccess,this),error:t.bind(this._clickEventError,this)})},_clickEventSuccess:function(){this.mb.publish(e.EVENTS.DISCOVERY_API.CLICK_EVENT_SUCCESS)},_clickEventError:function(t,n,r){this.mb.publish(e.EVENTS.DISCOVERY_API.CLICK_EVENT_ERROR,{xhr:t,status:n,error:r})},_fetchRelatedVideos:function(r){this.error=!1,this.relatedVideos=[];var s={sign_version:"player",pcode:e.playerParams.pcode,discovery_profile_id:e.playerParams.playerBrandingId,video_pcode:e.playerParams.pcode,limit:i,device_id:this.guid,expected_bucket_info_version:2,expires:Math.floor((new Date).getTime()/1e3+3600)},o=encodeURIComponent(this._generateSignature(s));s.device_id=encodeURIComponent(s.device_id);var u="//"+this.apiHost+"/v2/discover/similar/assets/"+r+"?"+this._generateParamString(s,o);n.ajax({url:u,type:"GET",dataType:"json",crossDomain:!0,cache:!0,success:t.bind(this._onRelatedVideosFetched,this),error:t.bind(this._onApiError,this)})},_onRelatedVideosFetched:function(t){var n=e.HM.safeObject("discovery.relatedVideos",t,{});n.errors===undefined||n.errors&&n.errors.code===0?(this.relatedVideos=n.results||[],this.variationIds=n.variation_ids):(this.relatedVideos=[],this.variationIds=[]),this._reorderRelatedVideos(),this.mb.publish(e.EVENTS.REPORT_EXPERIMENT_VARIATIONS,{variationIds:this.variationIds}),this.mb.publish(e.EVENTS.DISCOVERY_API.RELATED_VIDEOS_FETCHED,{videos:this.relatedVideos})},_onApiError:function(t,n,r){this.error=!0,this.mb.publish(e.EVENTS.DISCOVERY_API.RELATED_VIDEOS_FETCHED,{error:!0})},_generateSignature:function(e){var n=e.pcode,r=t.reject(t.keys(e),function(e){return e==="pcode"}),i=new jsSHA(n+this._hashToString(e,"",r),"ASCII");return i.getHash("SHA-256","B64").substring(0,43)},_hashToString:function(e,n,r){var i="",s=r||t.keys(e);return t.each(t.sortBy(s,function(e){return e}),function(t){i+=n+t+"="+e[t]}),i},_generateParamString:function(e,t){var n="signature="+t+this._hashToString(e,"&");return n},_reorderRelatedVideos:function(){for(var e=0;e<s.length;e++){var n=t.find(this.relatedVideos,function(t){return t.embed_code==s[e]});n&&(this.relatedVideos=t.filter(this.relatedVideos,function(t){return t.embed_code!=s[e]}),this.relatedVideos.push(n))}}}),o})
