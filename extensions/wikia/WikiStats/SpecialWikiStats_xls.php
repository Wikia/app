<?php

/**
 * @package MediaWiki
 * @subpackage SpecialPage - generate XLS files for statistics
 * @author Piotr Molski <moli@wikia.com>
 * @version: $Id$
 */

class WikiStatsXLS {
	//--
	var $mStats;
	var $mData = array();
	var $mFileName;
	function __construct( $oStats, $data = array(), $filename = 'default' ) {
		$this->mStats = $oStats;
		if ( !empty($data) && is_array($data) ) {
			$this->mData = $data;
		}
		$this->mFileName = $filename;
	}

	private function setXLSFileBegin() {
		echo pack("ssssss", 0x809, 0x8, 0x0, 0x10, 0x0, 0x0);
		return;
	}

	private function setXLSFileEnd() {
		exit(pack("ss", 0x0A, 0x00));
	}

	private function mergeXLSColsRows($row, $col, $to_row, $to_col) {
		echo pack("ss", 0xE5, 0x0A);
		echo pack("sssss", 1, $row, $to_row, $col, $to_col);
	}

	private function writeXLSNumber($row, $col, $value) {
		if (strpos($value, ",") !== false) {
			$this->writeXLSLabel($row, $col, $value);
		} else {
			if (isset($value)) {
				echo pack("sssss", 0x203, 14, $row, $col, 0x0);
				echo pack("d", sprintf("%0.2f", $value));
			}
		}
		return;
	}

	private function getStatsDateFormat($showYear = 1) {
		global $wgUser;
		$return = $dateFormat = $wgUser->getDatePreference();
		switch ($dateFormat) {
			case "mdy" : $return = (!empty($showYear)) ? "M j, Y" : "M j"; break;
			case "dmy" : $return = (!empty($showYear)) ? "j M Y" : "j M"; break;
			case "ymd" : $return = (!empty($showYear)) ? "Y M j" : "M j"; break;
			case "ISO 8601" : $return = (!empty($showYear)) ? "xnY-xnM-xnd" : "xnM-xnd"; break;
			default : $return = (!empty($showYear)) ? "M j, Y" : "M j"; break;
		}
		return $return;
	}
	
	private function checkColumnStatDate($date, $prev_date)
	{
		$addEmptyLine = false;
		wfProfileIn( __METHOD__ );
		#---
		if ( (strpos($prev_date,STATS_COLUMN_PREFIX) !== false) && (strpos($date,STATS_COLUMN_PREFIX) === false) ) {
			$addEmptyLine = 4;
		}
		elseif (strpos($prev_date,STATS_COLUMN_PREFIX) === false) {
			$datePrevArr = explode("-", $prev_date);
			$dateArr = explode("-", $date);
			if ($datePrevArr[0] != $dateArr[0]) { // years
				$addEmptyLine = 1;
			}
		}
		#---
		wfProfileOut( __METHOD__ );
		return $addEmptyLine;
	}
	
	private function makeCorrectDate($date, $today = 0) {
		global $wgLang;
		wfProfileIn( __METHOD__ );
		$dateArr = explode("-", $date);
		$stamp = mktime(23,59,59,$dateArr[1],1,$dateArr[0]);
		$corDate = ($today) ? $wgLang->sprintfDate( $this->getStatsDateFormat(0), wfTimestamp(TS_MW, $stamp))
						: $wgLang->sprintfDate("M Y", wfTimestamp(TS_MW, $stamp));
		wfProfileOut( __METHOD__ );
		return $corDate;
	}

	private function writeXLSLabel($row, $col, $value ) {
		$value = str_replace("<br/>", " ", $value);
		$value = str_replace("&lt;", "<", $value);
		$value = str_replace("&gt;", ">", $value);
		$len = strlen($value);
		echo pack("ssssss", 0x204, 8 + $len, $row, $col, 0x0, $len);
		echo $value;
		return;
	}

	public function setXLSHeader() {
		header("HTTP/1.0 200 OK");
		header("Pragma: public");
		header("Expires: 0");
		header("Cache-Control: must-revalidate, post-check=0, pre-check=0");
		header("Content-Type: application/force-download");
		header("Content-Type: application/octet-stream");
		header("Content-Type: application/download");;
		header("Content-Disposition: attachment;filename=".str_replace(" ", "_", $this->mFileName).".xls ");
		header("Content-Transfer-Encoding: binary ");
	}

	public function generateEmptyFile()	{
		$this->setXLSHeader();
		#----
		$this->setXLSFileBegin();
		$this->setXLSFileEnd();
	}

	public function makeMainStats() {
		global $wgLang;

		// Headers and meta for the start of the XLS file
		$this->setXLSHeader();
		$this->setXLSFileBegin();

		// Write column headers
		// Format: writeXLSLabel( ROW, COL, CONTENTS )
		$this->writeXLSLabel( 0, 0,  wfMsg('wikistats_date') );
		$this->writeXLSLabel( 0, 1,  wfMsg('wikistats_lifetime_editors') );
		$this->writeXLSLabel( 0, 2,  wfMsg('wikistats_content_editors') );
		$this->writeXLSLabel( 0, 3,  wfMsg('wikistats_edits').' > 5' );
		$this->writeXLSLabel( 0, 4,  wfMsg('wikistats_edits').' > 100' );
		$this->writeXLSLabel( 0, 5,  wfMsg('wikistats_article_total') );
		$this->writeXLSLabel( 0, 6,  wfMsg('wikistats_edits') );
		$this->writeXLSLabel( 0, 7,  wfMsg('wikistats_image_uploads') );
		$this->writeXLSLabel( 0, 8,  wfMsg('wikistats_video_uploads') );
		$this->writeXLSLabel( 0, 9,  wfMsg('wikistats_article_created') );
		$this->writeXLSLabel( 0, 10, wfMsg('wikistats_article_talk') );
		$this->writeXLSLabel( 0, 11, wfMsg('wikistats_blog_created') );
		$this->writeXLSLabel( 0, 12, wfMsg('wikistats_blog_comment') );
		$this->writeXLSLabel( 0, 13, wfMsg('wikistats_photo_new') );
		$this->writeXLSLabel( 0, 14, wfMsg('wikistats_video_new') );
		$this->writeXLSLabel( 0, 15, wfMsg('wikistats_user_page_edits') );
		$this->writeXLSLabel( 0, 16, wfMsg('wikistats_user_talk_edits') );

		// Write out data in reverse chronological order
		$row = 0;
		foreach ($this->mData as $date => $data) {
			$row++;
			$col = 0;
			foreach ($data as $column_name => $value) {
				switch ($column_name) {
					case 'date':
						// If this row is for the current month, format it differently
						if ( $value == date("Ym") ) {
							$value = $wgLang->sprintfDate( $this->mStats->dateFormat(0), wfTimestamp(TS_MW, time()));
						} else {
							$value = $wgLang->sprintfDate("M Y", $value.'01000000');
						}
						$this->writeXLSLabel($row, $col, $value);
						break;
					case 'label':
						$this->writeXLSLabel($row, $col, $value);
						break;
					case 'F':
					case 'H':
					case 'J':
						// Skipping these columns
						$col--;
						break;
					default:
						$value = empty($value) ? "0" : sprintf("%0.1f", $value);
						$this->writeXLSNumber($row, $col, $value);
						break;
				}
				$col++;
			}
		}

		$this->setXLSFileEnd();
	}

	public function makeDistribStats($city_id, &$statsData)
	{
		#----
		$dbname = $this->getXLSCityDBName($city_id);
		#----
		#wfMsg('wikistats_filename_other1', $dbname)
		$this->setXLSHeader();
		#----
		$this->setXLSFileBegin();
		$this->writeXLSLabel(1,1,ucfirst($dbname). " - " .wfMsg('wikistats_distrib_article'));
		$this->mergeXLSColsRows(1, 0, 1, 5);
		/*
		 * table header
		 */
		$this->writeXLSLabel(3, 0, wfMsg('wikistats_distrib_edits'));
		$this->writeXLSLabel(3, 1, wfMsg('wikistats_distrib_wikians'));
		$this->mergeXLSColsRows(3, 1, 3, 2);
		$this->writeXLSLabel(3, 3, wfMsg('wikistats_distrib_edits_total'));
		$this->mergeXLSColsRows(3, 3, 3, 4);
		//----
		$this->writeXLSLabel(4, 1, '#');
		$this->writeXLSLabel(4, 2, '%');
		$this->writeXLSLabel(4, 3, '#');
		$this->writeXLSLabel(4, 4, '%');
		/*
		 * data
		 */
		$row = 5;
		foreach ($statsData as $id => $data) {
			$col = 0;
			$this->writeXLSNumber($row,$col,$data['edits']);$col++;
			$this->writeXLSNumber($row,$col,$data['wikians']);$col++;
			$this->writeXLSNumber($row,$col,str_replace("%","",$data['wikians_perc']));$col++;
			$this->writeXLSNumber($row,$col,$data['edits_total']);$col++;
			$this->writeXLSNumber($row,$col,str_replace("%","",$data['edits_total_perc']));$col++;
			$row++;
		}
		#---
		unset($statsData);
		$this->setXLSFileEnd();
	}

	public function makeActiveWikiansStats($city_id, &$active, &$absent)
	{
		global $wgLang;
		#----
		$dbname = $this->getXLSCityDBName($city_id);
		$cur_month = 1;
		#----
		#wfMsg('wikistats_filename_other2', $dbname)
		$this->setXLSHeader();
		#----
		$this->setXLSFileBegin();
		$this->writeXLSLabel(1,0,ucfirst($dbname). " - " .wfMsg('wikistats_active_absent_wikians'));
		$this->mergeXLSColsRows(1, 0, 1, 11);

		$row = 3;
		if (!empty($active)) {
			/*
			 * header
			 */
			$this->writeXLSLabel(3,0,wfMsg('wikistats_recently_active_wikians', count($active)));
			$this->mergeXLSColsRows(3, 0, 3, 11);
			$this->writeXLSLabel(4,0,wfMsg('wikistats_active_wikians_subtitle_info'));
			$this->mergeXLSColsRows(4, 0, 4, 11);
			// first row of table
			$this->writeXLSLabel(6,0,wfMsg('wikistats_username'));
			$this->writeXLSLabel(6,1,wfMsg('wikistats_edits'));
			$this->mergeXLSColsRows(6, 1, 6, 6);
			$this->writeXLSLabel(6,7,wfMsg('wikistats_first_edit'));
			$this->mergeXLSColsRows(6, 7, 7, 8);
			$this->writeXLSLabel(6,9,wfMsg('wikistats_last_edit'));
			$this->mergeXLSColsRows(6, 9, 7, 10);
			// second row
			$this->writeXLSLabel(7,1,wfMsg('wikistats_articles_text'));
			$this->mergeXLSColsRows(7, 1, 7, 4);
			$this->writeXLSLabel(7,5,wfMsg('wikistats_other'));
			$this->mergeXLSColsRows(7, 5, 7, 6);
			// third row
			$this->writeXLSLabel(8,1,wfMsg('wikistats_rank'));
			$this->mergeXLSColsRows(8, 1, 8, 2);
			$this->writeXLSLabel(8,3,wfMsg('wikistats_month_ago', $cur_month, ($cur_month == 1) ? wfMsg('wikistats_active_month') : wfMsg('wikistats_active_months')));
			$this->mergeXLSColsRows(8, 3, 9, 3);
			$this->writeXLSLabel(8,4,wfMsg('wikistats_total'));
			$this->mergeXLSColsRows(8, 4, 9, 4);
			$this->writeXLSLabel(8,5,wfMsg('wikistats_total'));
			$this->mergeXLSColsRows(8, 5, 9, 5);
			$this->writeXLSLabel(8,6,wfMsg('wikistats_month_ago', $cur_month, ($cur_month == 1) ? wfMsg('wikistats_active_month') : wfMsg('wikistats_active_months')));
			$this->mergeXLSColsRows(8, 6, 9, 6);
			$this->writeXLSLabel(8,7,wfMsg('wikistats_date'));
			$this->mergeXLSColsRows(8, 7, 9, 7);
			$this->writeXLSLabel(8,8,wfMsg('wikistats_days_ago'));
			$this->mergeXLSColsRows(8, 8, 9, 8);
			$this->writeXLSLabel(8,9,wfMsg('wikistats_date'));
			$this->mergeXLSColsRows(8, 9, 9, 9);
			$this->writeXLSLabel(8,10,wfMsg('wikistats_days_ago'));
			$this->mergeXLSColsRows(8, 10, 9, 10);
			// 4th row
			$this->writeXLSLabel(9,1,wfMsg('wikistats_now'));
			$this->writeXLSLabel(9,2,wfMsg('wikistats_prev_rank_xls'));

			$row = 10;
			foreach ($active as $rank => $data) {
				$rank_change = $data['rank_change'];
				if ($data['rank_change'] > 0) {
					$rank_change = "+".$rank_change;
				} elseif ($data['rank_change'] == 0) {
					$rank_change = "...";
				}
				#---
				$outFirstEdit = $wgLang->sprintfDate( $this->getStatsDateFormat(), wfTimestamp(TS_MW, $data['first_edit']));
				#$outFirstEdit = wfMsg(strtolower(date("M",$data['first_edit']))) . " " . date("d",$data['first_edit']) .", ".date("Y",$data['first_edit']);
				#---
				#$outLastEdit = wfMsg(strtolower(date("M",$data['last_edit']))) . " " . date("d",$data['last_edit']) .", ".date("Y",$data['last_edit']);
				$outLastEdit = $wgLang->sprintfDate( $this->getStatsDateFormat(), wfTimestamp(TS_MW, $data['last_edit']));

				// write data
				$col = 0;
				$this->writeXLSLabel($row,$col,$data['user_name']); $col++;
				$this->writeXLSNumber($row,$col,intval($rank)); $col++;
				$this->writeXLSLabel($row,$col,$rank_change); $col++;
				$this->writeXLSNumber($row,$col,intval($data['edits_last'])); $col++;
				$this->writeXLSNumber($row,$col,intval($data['total'])); $col++;
				$this->writeXLSNumber($row,$col,intval($data['total_other'])); $col++;
				$this->writeXLSNumber($row,$col,intval($data['edits_other_last'])); $col++;
				$this->writeXLSLabel($row,$col,$outFirstEdit); $col++;
				$this->writeXLSNumber($row,$col,intval($data['first_edit_ago'])); $col++;
				$this->writeXLSLabel($row,$col,$outLastEdit); $col++;
				$this->writeXLSNumber($row,$col,intval($data['last_edit_ago'])); $col++;

				$row++;
			}
			if (!empty($active)) {
				$row++;
			}
		}

		// absent wikians
		$row++;
		if (!empty($absent)) {
			/*
			 * header
			 */
			$this->writeXLSLabel($row,0,wfMsg('wikistats_recently_absent_wikians', count($absent)));
			$this->mergeXLSColsRows($row, 0, $row, 6);
			$row = $row + 2;
			// first row of table
			$this->writeXLSLabel($row,0,wfMsg('wikistats_username'));
			$this->writeXLSLabel($row,1,wfMsg('wikistats_edits'));
			$this->mergeXLSColsRows($row, 1, $row, 2);
			$this->writeXLSLabel($row,3,wfMsg('wikistats_first_edit'));
			$this->mergeXLSColsRows($row, 3, $row, 4);
			$this->writeXLSLabel($row,5,wfMsg('wikistats_last_edit'));
			$this->mergeXLSColsRows($row, 5, $row, 6);
			$row++;
			// second row
			$this->writeXLSLabel($row,1,wfMsg('wikistats_rank'));
			$this->writeXLSLabel($row,2,wfMsg('wikistats_total'));
			$this->writeXLSLabel($row,3,wfMsg('wikistats_date'));
			$this->writeXLSLabel($row,4,wfMsg('wikistats_days_ago'));
			$this->writeXLSLabel($row,5,wfMsg('wikistats_date'));
			$this->writeXLSLabel($row,6,wfMsg('wikistats_days_ago'));

			$row++;
			foreach ($absent as $rank => $data) {
				#---
				$outFirstEdit = $wgLang->sprintfDate( $this->getStatsDateFormat(), wfTimestamp(TS_MW, $data['first_edit']));
				#$outFirstEdit = wfMsg(strtolower(date("M",$data['first_edit']))) . " " . date("d",$data['first_edit']) .", ".date("Y",$data['first_edit']);
				#---
				$outLastEdit = $wgLang->sprintfDate( $this->getStatsDateFormat(), wfTimestamp(TS_MW, $data['last_edit']));
				#$outLastEdit = wfMsg(strtolower(date("M",$data['last_edit']))) . " " . date("d",$data['last_edit']) .", ".date("Y",$data['last_edit']);
				#---
				$col = 0;
				$this->writeXLSLabel($row,$col,$data['user_name']); $col++;
				$this->writeXLSNumber($row,$col,intval($rank)); $col++;
				$this->writeXLSNumber($row,$col,intval($data['total'])); $col++;
				$this->writeXLSLabel($row,$col,$outFirstEdit); $col++;
				$this->writeXLSNumber($row,$col,intval($data['first_edit_ago'])); $col++;
				$this->writeXLSLabel($row,$col,$outLastEdit); $col++;
				$this->writeXLSNumber($row,$col,intval($data['last_edit_ago'])); $col++;
				#---
				$row++;
			}
		}
		unset($active);
		unset($absent);
		$this->setXLSFileEnd();
	}

	public function makeWikiaAnonUsersStats($city_id, &$anonData)
	{
		global $wgLang;
		#----
		$dbname = $this->getXLSCityDBName($city_id);
		$cur_month = 1;
		#----
		#wfMsg('wikistats_filename_other3', $dbname)
		$this->setXLSHeader();
		#----
		$this->setXLSFileBegin();
		$this->writeXLSLabel(1,0,ucfirst($dbname). " - " .wfMsg('wikistats_anon_wikians'));
		$this->mergeXLSColsRows(1, 0, 1, 7);
		$this->writeXLSLabel(3,0,ucfirst($dbname). " - " .wfMsg('wikistats_anon_wikians_count', count($anonData)));
		$this->mergeXLSColsRows(3, 0, 3, 7);

		$row = 5;
		if (!empty($anonData)) {
			/*
			 * Header
			 */
			$this->writeXLSLabel($row,0,wfMsg('wikistats_username'));
			$this->writeXLSLabel($row,1,wfMsg('wikistats_edits'));
			$this->mergeXLSColsRows($row, 1, $row, 2);
			$this->writeXLSLabel($row,3,wfMsg('wikistats_first_edit'));
			$this->mergeXLSColsRows($row, 3, $row, 4);
			$this->writeXLSLabel($row,5,wfMsg('wikistats_last_edit'));
			$this->mergeXLSColsRows($row, 5, $row, 6);
			$row++;
			$this->writeXLSLabel($row,1,wfMsg('wikistats_rank'));
			$this->writeXLSLabel($row,2,wfMsg('wikistats_total'));
			$this->writeXLSLabel($row,3,wfMsg('wikistats_date'));
			$this->writeXLSLabel($row,4,wfMsg('wikistats_days_ago'));
			$this->writeXLSLabel($row,5,wfMsg('wikistats_date'));
			$this->writeXLSLabel($row,6,wfMsg('wikistats_days_ago'));
			$row++;
			$rank = 0;
			foreach ($anonData as $id => $data) {
				$rank++;
				#---
				$outFirstEdit = $wgLang->sprintfDate( $this->getStatsDateFormat(), wfTimestamp(TS_MW, $data['min']));
				#$outFirstEdit = wfMsg(strtolower(date("M",$data['min']))) . " " . date("d",$data['min']) .", ".date("Y",$data['min']);
				#---
				#$outLastEdit = wfMsg(strtolower(date("M",$data['max'])))  . " " . date("d",$data['max']) .", ".date("Y",$data['max']);
				$outLastEdit = $wgLang->sprintfDate( $this->getStatsDateFormat(), wfTimestamp(TS_MW, $data['max']));
				#---
				$col = 0;
				$this->writeXLSLabel($row,$col,$data['user_name']); $col++;
				$this->writeXLSNumber($row,$col,intval($rank)); $col++;
				$this->writeXLSNumber($row,$col,intval($data['cnt'])); $col++;
				$this->writeXLSLabel($row,$col,$outFirstEdit); $col++;
				$this->writeXLSNumber($row,$col,sprintf("%0.0f", (time() - $data["min"])/(60*60*24))); $col++;
				$this->writeXLSLabel($row,$col,$outLastEdit); $col++;
				$this->writeXLSNumber($row,$col,sprintf("%0.0f", (time() - $data["max"])/(60*60*24))); $col++;
				#---
				$row++;
			}
		}

		unset($anonData);
		$this->setXLSFileEnd();
	}

	public function makeArticleSizeStats($city_id, &$articleCount, &$articleSize)
	{
		global $wgLang;
		#----
		$dbname = $this->getXLSCityDBName($city_id);
		$cur_month = 1;
		#----
		#wfMsg('wikistats_filename_other4', $dbname)
		$this->setXLSHeader();
		#----
		$this->setXLSFileBegin();
		$this->writeXLSLabel(1,0,ucfirst($dbname). " - " .wfMsg('wikistats_article_one_link'));
		$this->mergeXLSColsRows(1, 0, 1, count($articleSize) + 1);

		/*
		 * Header
		 */
		$row = 3;
		$this->writeXLSLabel($row,0,wfMsg('wikistats_date'));
		$this->writeXLSLabel($row,1,wfMsg('wikistats_articles_text') . "(%)");
		$this->mergeXLSColsRows($row, 1, $row, count($articleSize));
		$row++;
		// second line
		$col = 1;
		foreach ($articleSize as $s => $values) {
			$bT = wfMsg('size-bytes', $s);
			$text = "< ".$bT;
			if ($s >= 1024) {
				$kbT = wfMsg('size-kilobytes', sprintf("%.0f", $s/1024));
				$text = "< ".$kbT;
			}
			$this->writeXLSLabel($row,$col,$text);
			$col++;
		}

		$row++;
		foreach ($articleCount as $date => $monthStats) {
			$col = 0;
			$cntAll = intval($monthStats['count']);
			#---
			$dateArr = explode("-",$date);
			$stamp = mktime(23,59,59,$dateArr[1],1,$dateArr[0]);
			#---
			#$out = wfMsg(strtolower(date("M",$stamp))) . " " . $dateArr[0];
			$out = $wgLang->sprintfDate("M Y", wfTimestamp(TS_MW, $stamp));
			#---
			if ($date == date("Y-m")) {
				$out = $wgLang->sprintfDate( $this->getStatsDateFormat(), wfTimestamp(TS_MW, $stamp));
				#$out = wfMsg(strtolower(date("M",$stamp))) . " " . date("d") . ", " . $dateArr[0];
			}
			#---
			$this->writeXLSLabel($row,$col,$out);
			#---
			foreach ($articleSize as $s => $values) {
				$col++;
				$cntDate = array_key_exists($date, $values) ? intval($values[$date]['count']) : 0;
				$rowValue = $wgLang->formatNum(sprintf("%0.1f", ($cntDate * 100) / $cntAll));
				$this->writeXLSNumber($row,$col,$rowValue);
			}
			$row++;
		}

		unset($articleCount);
		unset($articleSize);
		$this->setXLSFileEnd();
	}

	public function makeDBNamespaceStats($city_id, &$namespaceCount, &$nspaces, &$allowedNamespace)
	{
		global $wgLang;

		$kB = 1000;
		$mB = $kB * $kB;
		#----
		$dbname = $this->getXLSCityDBName($city_id);
		$cur_month = 1;
		#----
		#wfMsg('wikistats_filename_other5', $dbname)
		$this->setXLSHeader();
		#----
		$this->setXLSFileBegin();
		$this->writeXLSLabel(1,0,ucfirst($dbname). " - " .wfMsg('wikistats_namespace_records'));
		$this->mergeXLSColsRows(1, 0, 1, count($allowedNamespace) + 1);

		/*
		 * Header
		 */
		$row = 3;
		$this->writeXLSLabel($row,0,wfMsg('wikistats_date'));
		$this->writeXLSLabel($row,1,wfMsg('wikistats_namespace'));
		$this->mergeXLSColsRows($row, 1, $row, count($allowedNamespace));
		$row++;
		// second row
		$col = 0;
		foreach ($nspaces as $n => $nName) {
			if (in_array($n, $allowedNamespace)) {
				$col++;
				$this->writeXLSLabel($row,$col,$nName);
			}
		}

		// data
		$row++;
		foreach ($namespaceCount as $date => $monthStats)
		{
			$cntAll = (array_key_exists('count', $monthStats)) ? intval($monthStats['count']) : 0;
			#---
			$col = 0;
			$dateArr = explode("-",$date);
			$stamp = mktime(23,59,59,$dateArr[1],1,$dateArr[0]);
			#$out = wfMsg(strtolower(date("M",$stamp))) . " " . $dateArr[0];
			$out = $wgLang->sprintfDate("M Y", wfTimestamp(TS_MW, $stamp));
			if ($date == date("Y-m")) {
				$out = $wgLang->sprintfDate( $this->getStatsDateFormat(), wfTimestamp(TS_MW, $stamp));
				#$out = wfMsg(strtolower(date("M",$stamp))) . " " . date("d") . ", " . $dateArr[0];
			}
			#---
			$this->writeXLSLabel($row,$col,$out);
			#---

			foreach ($nspaces as $n => $nName) {
				if (in_array($n, $allowedNamespace)) {
					$col++;
					$val = (array_key_exists($n, $monthStats)) ? intval($monthStats[$n]) : 0;
					//$out = (empty($val)) ? "" : ($val >= $kB) ? sprintf ("%.1f", $val/$kB)." k" : (($val >= $mB) ? sprintf ("%.1f", $val/$mB)." M" : $val);
					$this->writeXLSNumber($row,$col,$val);
				}
			}
			$row++;
		}

		unset($namespaceCount);
		unset($nspaces);
		unset($allowedNamespace);
		$this->setXLSFileEnd();
	}

	public function makeMostEditPagesStats($city_id, &$statsCount, &$mSourceMetaSpace)
	{
		global $wgCanonicalNamespaceNames;
		global $wgLang, $wgDBname, $wgSharedDB;

		$dbname = $this->getXLSCityDBName($city_id);
		$cur_month = 1;
		#----
		#wfMsg('wikistats_filename_other6', $dbname)
		$this->setXLSHeader();
		$centralVersion = ($wgDBname == $wgSharedDB);
		#----
		$this->setXLSFileBegin();
		$this->writeXLSLabel(1,0,ucfirst($dbname). " - " .str_replace("&gt;", ">", wfMsgHtml('wikistats_page_edits')) );
		$this->mergeXLSColsRows(1, 0, 1, 6);
		$this->writeXLSLabel(3,0,wfMsg('wikistats_page_edits_count', count($statsCount)));
		$this->mergeXLSColsRows(3, 0, 3, 6);

		/*
		 * Header
		 */
		$row = 5;
		$this->writeXLSLabel($row,0,'#');
		$this->writeXLSLabel($row,1,wfMsg('wikistats_edits'));
		$this->mergeXLSColsRows($row, 1, $row, 2);
		$this->writeXLSLabel($row,3,wfMsg('wikistats_unique_users'));
		$this->mergeXLSColsRows($row, 3, $row, 4);
		$this->writeXLSLabel($row,5,wfMsg('wikistats_articles_text'));
		$this->mergeXLSColsRows($row, 5, $row+1, 5);
		$this->writeXLSLabel($row,6,wfMsg('wikistats_archived'));
		$this->mergeXLSColsRows($row, 6, $row+1, 6);
		// second row
		$row++;
		$this->writeXLSLabel($row,1,ucfirst(wfMsg('wikistats_total')));
		$this->writeXLSLabel($row,2,wfMsg('wikistats_register') . " [%]");
		$this->writeXLSLabel($row,3,wfMsg('wikistats_register'));
		$this->writeXLSLabel($row,4,wfMsg('wikistats_unregister'));

		$row++;
		if (!empty($statsCount)) {
			$Kb = 1024 ;
			$Mb = $Kb * $Kb ;
			$Gb = $Kb * $Kb * $Kb ;

			$rank = 0;
			foreach ($statsCount as $cnt => $stats) {
				$col = 0;
				$rank++;
				$reg_edits = ($stats['reg_edits']) ? sprintf("%0.0f", ($stats['reg_edits']/$cnt) * 100) : sprintf("%0.0f", $stats['reg_edits']);
				#---
				if ($stats['archived'] < $Mb) {
					$mbT = wfMsg('size-megabytes', 1);
					$size = "< " . $mbT;
				} else {
					$size = wfMsg('size-megabytes', $wgLang->formatNum(sprintf ("%.1f", $stats['archived'] / $Mb)));
				}
				#---

    			if (!empty($centralVersion)) {
    				$naName = (array_key_exists($stats['namespace'], $wgCanonicalNamespaceNames)) ? $wgCanonicalNamespaceNames[$stats['namespace']] : "";
					if (in_array($stats['namespace'], array(NS_PROJECT, NS_PROJECT_TALK))) {
						$canonName = (array_key_exists($stats['namespace'], $wgCanonicalNamespaceNames)) ? $wgCanonicalNamespaceNames[$stats['namespace']] : "";
						$naName = (!empty($projectNamespace)) ? $projectNamespace : $canonName;
						if ( ($stats['namespace'] == NS_PROJECT_TALK) && (!empty($projectNamespace)) ) {
							$aC = explode("_", $canonName);
							if ( count( $aC ) > 1 ) {
								$naName = $projectNamespace."_".$aC[ count( $aC ) - 1 ];
							}
						}
					}
					$title = ($naName) ? $naName . ":" . $stats['page_title'] : $stats['page_title'];
				} else {
					$t = Title::newFromText($stats['page_title'], $stats['namespace']);
					$title = $t->getPrefixedDBKey();
				}

				#---
				$this->writeXLSNumber($row, $col, intval($rank));$col++;
				$this->writeXLSNumber($row, $col, intval($cnt));$col++;
				$this->writeXLSNumber($row, $col, $reg_edits);$col++;
				$this->writeXLSNumber($row, $col, $stats['reg_users']);$col++;
				$this->writeXLSNumber($row, $col, $stats['unreg_users']);$col++;
				$this->writeXLSLabel($row, $col, $title);$col++;
				$this->writeXLSLabel($row, $col, $size);$col++;

				$row++;
			}
		}

		unset($statsCount);
		unset($mSourceMetaSpace);
		$this->setXLSFileEnd();
	}


	public function makePageViewsXLS($city_id, $statsCount, $mSourceMetaSpace, $otherNspaces)
	{
		global $wgCanonicalNamespaceNames;
		global $wgLang, $wgDBname, $wgSharedDB;

		$canonicalNamespace = WikiFactory::getVarValueByName('wgExtraNamespacesLocal', $city_id);
		if ( is_array($canonicalNamespace) ) {
			$canonicalNamespace = array_merge($wgCanonicalNamespaceNames, $canonicalNamespace);
		} else {
			$canonicalNamespace = $wgCanonicalNamespaceNames;
		}

		$dbname = $this->getXLSCityDBName($city_id);
		$cur_month = 1;
		#----
		#wfMsg('wikistats_filename_other8', $dbname)
		$this->setXLSHeader();
		$centralVersion = ($wgDBname == $wgSharedDB);
		#----
		$this->setXLSFileBegin();
		$this->writeXLSLabel(1,0,ucfirst($dbname). " - " .wfMsg('wikistats_pageviews') );
		$this->mergeXLSColsRows(1, 0, 1, 6);
		$this->writeXLSLabel(2,0,wfMsg('wikistats_pageviews_subtext'));
		$this->mergeXLSColsRows(2, 0, 2, 6);
		$this->writeXLSLabel(3,0,wfMsg('wikistats_pageviews_counting'));
		$this->mergeXLSColsRows(3, 0, 3, 6);

		/*
		 * Header
		 */
		$aNamespaces = $statsCount['namespaces'];
		ksort($aNamespaces, SORT_NUMERIC);
		$row = 5;
		$this->writeXLSLabel($row,1,wfMsg('wikistats_date'));
		$this->mergeXLSColsRows($row, 1, $row+1, 1);
		$this->writeXLSLabel($row,2,wfMsg('wikistats_namespace'));
		$this->mergeXLSColsRows($row, 2, $row, 2+(count($aNamespaces)-1));

		$row++;
		$loop = 0; foreach ($aNamespaces as $id => $value) {
			$this->writeXLSLabel($row,2+$loop, ($id == 0) ? $wgLang->ucfirst(wfMsg('wikistats_content')) : (isset($canonicalNamespace[$id]) ? $canonicalNamespace[$id] : $id));
			$loop++;
		}

		$rows = $rows_month = array();
		if (!empty($statsCount['months'])) {
			$loop = 0;
			foreach ($statsCount['months'] as $date => $values) {
				$aRow = array();
				$dateArr = explode("-",$date);
				$is_month = 0; if (!isset($dateArr[2])) {
					$is_month = 1;
				}
				/*$stamp = mktime(23,59,59,$dateArr[1],($is_month)?1:$dateArr[2],$dateArr[0]);
				$out = $wgLang->sprintfDate(($is_month)?"M Y":$this->getStatsDateFormat(1), wfTimestamp(TS_MW, $stamp));
				*/
				$aRow[] = $date; #$out;
				foreach ($aNamespaces as $id => $value) {
					$_tmp = (isset($values[$id])) ? $values[$id] : 0;
					$aRow[] = $_tmp;
				}
				($is_month == 0) ? $rows[] = $aRow : $rows_month[] = $aRow;
			}
		}

		# daily first
		$row++;
		if (!empty($rows)) {
			$loop = 0;
			for ($id = count($rows)-1; $id >= 0; $id--) {
				$aRow = $rows[$id];
				if (!empty($aRow)) {
					foreach ($aRow as $col => $value) {
						$this->writeXLSLabel($row + $loop,$col+1,$value);
					}
				}
				$loop++;
			}
			$row = $row + $loop;
		}

		# monthly next
		$row++;
		if (!empty($rows_month)) {
			$loop = 0;
			for ($id = count($rows_month)-1; $id >= 0; $id--) {
				$loop++;
				$aRow = $rows_month[$id];
				if (!empty($aRow)) {
					foreach ($aRow as $col => $value) {
						$this->writeXLSLabel($row+$loop,$col+1,$value);
					}
				}
			}
		}

		unset($statsCount);
		unset($mSourceMetaSpace);
		$this->setXLSFileEnd();
	}

	public function makeMostEditOtherNspacesStats($city_id, &$statsCount, &$mSourceMetaSpace)
	{
		global $wgCanonicalNamespaceNames;
		global $wgLang, $wgDBname, $wgSharedDB;

		$dbname = $this->getXLSCityDBName($city_id);
		$cur_month = 1;
		#----
		#wfMsg('wikistats_filename_other7', $dbname)
		$this->setXLSHeader();
		$centralVersion = ($wgDBname == $wgSharedDB);
		#----
		$this->setXLSFileBegin();
		$this->writeXLSLabel(1,0,ucfirst($dbname). " - " .str_replace("&gt;", ">", wfMsg('wikistats_other_nspaces_edits')) );
		$this->mergeXLSColsRows(1, 0, 1, 6);
		$this->writeXLSLabel(3,0,wfMsg('wikistats_other_nspaces_edits_count', count($statsCount)));
		$this->mergeXLSColsRows(3, 0, 3, 6);

		/*
		 * Header
		 */
		$row = 5;
		$this->writeXLSLabel($row,0,'#');
		$this->writeXLSLabel($row,1,wfMsg('wikistats_edits'));
		$this->mergeXLSColsRows($row, 1, $row, 2);
		$this->writeXLSLabel($row,3,wfMsg('wikistats_unique_users'));
		$this->mergeXLSColsRows($row, 3, $row, 4);
		$this->writeXLSLabel($row,5,wfMsg('wikistats_articles_text'));
		$this->mergeXLSColsRows($row, 5, $row+1, 5);
		$this->writeXLSLabel($row,6,wfMsg('wikistats_archived'));
		$this->mergeXLSColsRows($row, 6, $row+1, 6);
		// second row
		$row++;
		$this->writeXLSLabel($row,1,ucfirst(wfMsg('wikistats_total')));
		$this->writeXLSLabel($row,2,wfMsg('wikistats_register') . " [%]");
		$this->writeXLSLabel($row,3,wfMsg('wikistats_register'));
		$this->writeXLSLabel($row,4,wfMsg('wikistats_unregister'));

		$row++;
		if (!empty($statsCount)) {
			$Kb = 1024 ;
			$Mb = $Kb * $Kb ;
			$Gb = $Kb * $Kb * $Kb ;

			$rank = 0;
			foreach ($statsCount as $cnt => $stats) {
				$col = 0;
				$rank++;
				$reg_edits = ($stats['reg_edits']) ? sprintf("%0.0f", ($stats['reg_edits']/$cnt) * 100) : sprintf("%0.0f", $stats['reg_edits']);
				#---
				if ($stats['archived'] < $Mb) {
					$mbT = wfMsg('size-megabytes', 1);
					$size = "< " . $mbT;
				} else {
					$size = wfMsg('size-megabytes', $wgLang->formatNum(sprintf ("%.1f", $stats['archived'] / $Mb)));
				}
				#---
    			if (!empty($centralVersion)) {
    				$naName = (array_key_exists($stats['namespace'], $wgCanonicalNamespaceNames)) ? $wgCanonicalNamespaceNames[$stats['namespace']] : "";
					if (in_array($stats['namespace'], array(NS_PROJECT, NS_PROJECT_TALK))) {
						$canonName = (array_key_exists($stats['namespace'], $wgCanonicalNamespaceNames)) ? $wgCanonicalNamespaceNames[$stats['namespace']] : "";
						$naName = (!empty($projectNamespace)) ? $projectNamespace : $canonName;
						if ( ($stats['namespace'] == NS_PROJECT_TALK) && (!empty($projectNamespace)) ) {
							$aC = explode("_", $canonName);
							if ( count( $aC ) > 1 ) {
								$naName = $projectNamespace."_".$aC[ count( $aC ) - 1 ];
							}
						}
					}
					$title = ($naName) ? $naName . ":" . $stats['page_title'] : $stats['page_title'];
				} else {
					$t = Title::newFromText($stats['page_title'], $stats['namespace']);
					$title = $t->getPrefixedDBKey();
				}
				#---
				$this->writeXLSNumber($row, $col, intval($rank));$col++;
				$this->writeXLSNumber($row, $col, intval($cnt));$col++;
				$this->writeXLSNumber($row, $col, $reg_edits);$col++;
				$this->writeXLSNumber($row, $col, $stats['reg_users']);$col++;
				$this->writeXLSNumber($row, $col, $stats['unreg_users']);$col++;
				$this->writeXLSLabel($row, $col, $title);$col++;
				$this->writeXLSLabel($row, $col, $size);$col++;

				$row++;
			}
		}

		unset($statsCount);
		unset($mSourceMetaSpace);
		$this->setXLSFileEnd();
	}

	private function makeTrendMeanFormula($row1, $row2, $col1, $col2)
	{
		global $wgLang;
		#--- F O R M U L A ( mean )
		$sum = 0;
		$meanInfo = wfMsg('wikistats_trend_mean_info')." \r\n";
		$meanInfo .= wfMsg('wikistats_trend_formula'). ": ";
		for ($i = 1; $i <= WIKISTATS_TREND_MONTH; $i++) {
			$cur_date = mktime(23, 59, 59, (date('m') + 1) - (WIKISTATS_TREND_MONTH - $i), 0, date('Y'));
			#---
			$day = ($i == WIKISTATS_TREND_MONTH) ? date("d") : date("d", $cur_date);
			$sum += $day;
			$month = $wgLang->sprintfDate("M", wfTimestamp(TS_MW, $cur_date));
			#---
			$variable = "X" . $i;
			$meanArray[0][] = $variable;
			$meanArray[1][] = $variable . " = " . $day . " x " . wfMsg('wikistats_trend_value') . "[" . $month . "]";
			$meanArray[2][] = $day;
		}
		#---
		$meanInfo .= "(" . implode(" + ", $meanArray[0]) . ") / Y1 \n" . wfMsg('wikistats_trend_where_text') . " \n";
		$meanInfo .= implode(",\n", $meanArray[1]).",\n";
		$meanInfo .= "Y1 = ".implode(" + ", $meanArray[2])." = ". $sum ;

		$this->writeXLSLabel($row1,$col1,$meanInfo);
		$this->mergeXLSColsRows($row1, $col1, $row2, $col2);

		unset($meanInfo);
	}

	private function makeGrowthMeanFormula($row1, $row2, $col1, $col2)
	{
		global $wgLang;

		$growthInfo = wfMsg('wikistats_trend_growth_info'). "\n";
		$growthInfo .= wfMsg('wikistats_trend_formula'). ": ";
		#---
		$sum = 0;
		for ($i = 1; $i <= WIKISTATS_TREND_MONTH; $i++) {
			$cur_date = mktime(23, 59, 59, (date('m') + 1) - (WIKISTATS_TREND_MONTH - $i), 0, date('Y'));
			$next_date = mktime(23, 59, 59, (date('m') + 1) - (WIKISTATS_TREND_MONTH - $i - 1), 0, date('Y'));
			#---
			$day = ($i == WIKISTATS_TREND_MONTH) ? date("d") : date("d", $next_date);
			#---
			$month = $wgLang->sprintfDate("M", wfTimestamp(TS_MW, $cur_date));
			#---
			$next_month = $wgLang->sprintfDate("M", wfTimestamp(TS_MW, $next_date));
			#---
			if ($i < WIKISTATS_TREND_MONTH) {
				$sum += $day;
				$variable = "G" . $i ;
				$growthArray[0][] = $variable;
				$growthArray[1][] = $variable . "= " . $day . " x ([$next_month]-[$month])/[$month]";
				$growthArray[2][] = $day;
			}
		}
		#---
		$growthInfo .= "100% x (" . implode(" + ", $growthArray[0]) . ") / Y2 \n" . wfMsg('wikistats_trend_where_text') . "\n";
		$growthInfo .= implode(",\n", $growthArray[1]).",\n";
		$growthInfo .= "Y2 = ".implode(" + ", $growthArray[2])." = " . $sum;

		$this->writeXLSLabel($row1,$col1,$growthInfo);
		$this->mergeXLSColsRows($row1, $col1, $row2, $col2);

		unset($growthInfo);
	}

	private function makeCitiesMenu($cityOrderList, $cityList, $row, $col)
	{
		if (is_array($cityOrderList)) {
			foreach ($cityOrderList as $id => $city_id) {
				$wikiaName = ($city_id == 0) ? wfMsg('wikistats_trend_all_wikia_text') : $cityList[$city_id]['dbname'];
				$this->writeXLSLabel($row,$col,$wikiaName);
				$col++;
			}
		}
	}

	// TODO: remove? this method is not used anywhere
	public function makeTrendStats($city_id, &$trend_stats, &$month_array, &$cityList, &$cityOrderList)
	{
		global $wgLang;
		$G = 1000 * 1000 * 1000;
		$M = 1000 * 1000;
		$K = 1000;
		$GB = 1024 * 1024 * 1024;
		$MB = 1024 * 1024;
		$KB = 1024;

		#wfMsg('wikistats_filename_trend', date('Ymd'))
		$this->setXLSHeader();
		#----
		$this->setXLSFileBegin();
		$col = 0;
		$this->writeXLSLabel(1, $col, wfMsg('wikistats_comparisons_table_1'));
		$this->mergeXLSColsRows(1, $col, 1, $col + (count($cityOrderList) + 1));

		$row1 = 3; $row2 = (3 * $row1) + 2;
		$col1 = 0; $col2 = 4 * ($col1 + 1);
		$this->makeTrendMeanFormula($row1, $row2, $col1, $col2);

		$col1 = $col2 + 2; $col2 = $col1 + 5;
		$this->makeGrowthMeanFormula($row1, $row2, $col1, $col2);

		// show statistics
		$row = $row2 + 2;
		$i = 0;
		foreach ($trend_stats as $column => $dateValues) {
			$col1 = 0; $col2 = $col1 + 4;
			$linkText = array(
				"wikians" => wfMsg('wikistats_distrib_wikians'),
				"articles" => wfMsg('wikistats_articles_text'),
				"database" => wfMsg('wikistats_database'),
				"links" => wfMsg('wikistats_links'),
				"images" => wfMsg('wikistats_images')
			);

			$active = "";
			if (($i >= 0) && ($i < 7)) {
				$active = $linkText["wikians"];
				$linkText["wikians"] = "";
			} elseif ( ($i >= 7) && ($i < 14) ) {
				$active = $linkText["articles"];
				$linkText["articles"] = "";
			} elseif ( ($i >= 14) && ($i < 17) ) {
				$active = $linkText["database"];
				$linkText["database"] = "";
			} elseif ( ($i >= 17) && ($i < 22) ) {
				$active = $linkText["links"];
				$linkText["links"] = "";
			} elseif ( ($i >= 22) && ($i < 24) ) {
				$active = $linkText["images"];
				$linkText["images"] = "";
			}

			$loop = 0;
			$links = array();
			foreach ($linkText as $id => $name) {
				if (!empty($name)) {
					$links[] = $name;
				}
				$loop++;
			}

			$this->writeXLSLabel($row, $col1, "(".$column.") " . implode (" - ", $links));
			$this->mergeXLSColsRows($row, $col1, $row, $col2);

			$col1 = $col2 + 1;
			$this->writeXLSLabel($row, $col1, $active . " - " . wfMsg('wikistats_mainstats_short_column_' . $column));

			$row++; $col1 = 2;
			$this->makeCitiesMenu($cityOrderList, $cityList, $row, $col1);

			$loop = 0;
			$row++;
			foreach ($dateValues as $date => $cities) {
				$col1 = 0;
				$trend = 0;
				$growth = 0;
				if ($loop == 0) { #--- current date
					$dateArr = explode("-", date("Y-m-d"));
					#---
					$stamp = mktime(23,59,59,$dateArr[1],$dateArr[2],$dateArr[0]);
					#$outDate = wfMsg(strtolower(date("M",$stamp))) . " " . $dateArr[2] .", ". $dateArr[0];
					$outDate = $wgLang->sprintfDate( $this->getStatsDateFormat(), wfTimestamp(TS_MW, $stamp));
				} else {
					if (!in_array($date, array('trend', 'mean', 'growth'))) {
						$dateArr = explode("-", $date);
						#---
						$stamp = mktime(23,59,59,$dateArr[1],1,$dateArr[0]);
						#$outDate = wfMsg(strtolower(date("M",$stamp))) . " ".$dateArr[0];
						$outDate = $wgLang->sprintfDate("M Y", wfTimestamp(TS_MW, $stamp));
					} else {
						if ($date == 'trend') {
							$trend = 1;
							$dateArr = explode("-", date("Y-m-f"));
							#---
							$stamp = mktime(23,59,59,$dateArr[1],1,$dateArr[0]);
							#$outDate = wfMsg(strtolower(date("M",$stamp))) . " ".$dateArr[0];
							$outDate = $wgLang->sprintfDate("M Y", wfTimestamp(TS_MW, $stamp));
						} else {
							$outDate = ucfirst($date);
							$growth = ($date == 'growth') ? 1 : 0;
						}
					}
				}

				$this->writeXLSLabel($row, $col1, $outDate); $col2 = $col1 + 1;
				$this->mergeXLSColsRows($row, $col1, $row, $col2);

				$col1 = $col2 + 1;
				foreach ($cityOrderList as $id => $city_id) {
					$out = "";
					$city_values = (array_key_exists($city_id, $cities)) ? $cities[$city_id] : 0;
					if (empty($growth)) {
						if ($column == 'G')
							$out = sprintf("%0d", $city_values);
						elseif ($column == 'K')
							$out = $wgLang->formatNum(sprintf("%0.1f", $city_values));
						elseif ($column == 'L')
							$out = sprintf("%0.0f", $city_values);
						elseif (($column == 'M') || ($column == 'N'))
							$out = sprintf("%0d%%", $city_values * 100);
						elseif ($column == 'P') {
							if (intval($city_values) > $GB)
								$out = wfMsg('size-gibabytes', $wgLang->formatNum(sprintf("%0.1f", $city_values/$GB)));
							elseif (intval($city_values) > $MB)
								$out = wfMsg('size-megabytes', $wgLang->formatNum(sprintf("%0.1f", $city_values/$MB)));
							elseif ($city_values > $KB)
								$out = wfMsg('size-kilobytes', $wgLang->formatNum(sprintf("%0.1f", $city_values/$KB)));
							else
								$out = sprintf("%0d", intval($city_values));
						} else {
							$out = sprintf("%0d", $city_values);
						}
					} else {
						$out = sprintf("%0d", $city_values);
						if ($out >= 100) $out = "";
					}
					#---
					if ($trend == 1) {
						$out = "+/-".$out;
					}
					$out .= (($growth == 1) && ($out !== "") && (strpos($out,"%") === false)) ? "%" : "";

					if (is_numeric($out))
						$this->writeXLSNumber($row, $col1, $out);
					else
						$this->writeXLSLabel($row, $col1, $out);

					#---
					$col1++;
				}
				$loop++;
				$row++;
			}
			$row = $row + 2;
			$i++;
		}

		unset($cityList);
		unset($trend_stats);
		unset($month_array);
		unset($cityOrderList);
		$this->setXLSFileEnd();
	}

	public function makeCreationStats($cityList, &$arr_wikians, &$dWikians, &$arr_article, &$dArticles)
	{
		global $wgLang;
		#wfMsg('wikistats_filename_creation', date('Ymd'))
		$this->setXLSHeader();
		#----
		$max_wikians = (is_array($arr_wikians)) ? $arr_wikians[1] : 1;
		$max_articles = (is_array($arr_article)) ? $arr_article[1] : 1;
		$max_width = ($max_wikians >= $max_articles) ? $max_wikians : $max_articles;
		#---
		$wikians = (is_array($arr_wikians)) ? $arr_wikians[0] : array();
		$article = (is_array($arr_article)) ? $arr_article[0] : array();
		unset($arr_wikians);
		unset($arr_article);
		#---
		$this->setXLSFileBegin();
		$col = 0;
		$this->writeXLSLabel(1, $col, wfMsg('wikistats_creation_wikia_text'));
		#---
		$row = 3;
		$this->writeXLSLabel($row, $col, wfMsg('wikistats_mainstats_short_column_A') . "\n" . wfMsg('wikistats_mainstats_column_A'));
		#---
		$start_row = $row;
		if (!empty($dWikians) && is_array($dWikians)) {
			$col = 0;
			foreach ($dWikians as $id => $date)	{
				$row = $start_row + 3;
				$dateArr = explode("-", $date);
				#---
				$stamp = mktime(23,59,59,$dateArr[1],1,$dateArr[0]);
				#$outDate = wfMsg(strtolower(date("M",$stamp))) . " ".$dateArr[0];
				$outDate = $wgLang->sprintfDate("M Y", wfTimestamp(TS_MW, $stamp));

				$this->writeXLSLabel($row, $col, $outDate);
				#---
				$col++;
				$row++;
				if ( !empty($wikians) && !empty($wikians[$date]) ) {
					foreach ($wikians[$date] as $id => $wikiaInfo) {
						$dbname = (array_key_exists($wikiaInfo['city_id'], $cityList)) ? $cityList[$wikiaInfo['city_id']]['dbname'] : "";
						#---
						$this->writeXLSLabel($row, $col, $dbname."(".$wikiaInfo['cnt'].")");
						$row++;
					}
				}
			}
		}

		$row = $start_row;
		$col += 2;
		$this->writeXLSLabel($row, $col, wfMsg('wikistats_mainstats_short_column_E') . "\n" . wfMsg('wikistats_mainstats_column_E'));

		if (!empty($dArticles) && is_array($dArticles))	{
			foreach ($dArticles as $id => $date) {
				$row = $start_row + 3;
				$dateArr = explode("-", $date);
				#---
				$stamp = mktime(23,59,59,$dateArr[1],1,$dateArr[0]);
				#$outDate = wfMsg(strtolower(date("M",$stamp))) . " ".$dateArr[0];
				$outDate = $wgLang->sprintfDate("M Y", wfTimestamp(TS_MW, $stamp));
				#---
				$this->writeXLSLabel($row, $col, $outDate);
				#---
				$col++;
				$row++;
				if ( !empty($article) && !empty($article[$date]) ) {
					foreach ($article[$date] as $id => $wikiaInfo) {
						$dbname = (array_key_exists($wikiaInfo['city_id'], $cityList)) ? $cityList[$wikiaInfo['city_id']]['dbname'] : "";
						$this->writeXLSLabel($row, $col, $dbname."(".$wikiaInfo['cnt'].")");
						$row++;
					}
				}
			}
		}

		unset($cityList);
		unset($wikians);
		unset($dWikians);
		unset($article);
		unset($dArticles);
		$this->setXLSFileEnd();
	}

	public function makeColumnStats($column,&$cityList,$nbrCities,&$splitCityList,&$columnHistory,&$columnRange)
	{
		global $wgLang;

		$columnLetter = $columnRange[$column-3];
		#wfMsg("wikistats_filename_column_" . $columnLetter)
		$this->setXLSHeader();
		#----
		$this->setXLSFileBegin();
		$col = 1;
		$this->writeXLSLabel(1, $col, wfMsg("wikistats_filename_column_" . $columnLetter));
		$this->mergeXLSColsRows(1, $col, 1, $col + count($splitCityList));

		$rows = array(); $loop = 0;
		$col += 1; $row = 3;
		$this->makeCitiesMenu($splitCityList, $cityList, $row, $col);

		$loop = 0;
		$prev_date = "";
		foreach ($columnHistory as $date => $dateValues) {
			$col = 1; $row++;
			$show_percent = false;
			$cur_date = $date;
			#---
			$addEmptyLine = (!empty($prev_date)) ? $this->checkColumnStatDate($date, $prev_date) : false;
			#---
			if ($addEmptyLine !== false) {
				$this->mergeXLSColsRows($row, $col, $row, $col + count($splitCityList));
				$row++;
			}

			if (strpos($date, WIKISTATS_COLUMN_PREFIX) !== false) {
				$date = str_replace(WIKISTATS_COLUMN_PREFIX, "", $date);
				$show_percent = true;
			}
			#---
			$outDate = $this->makeCorrectDate($date, ($date==date('Y-m')));
			#---
			$this->writeXLSLabel($row, $col, $outDate);
			#---
			foreach ($splitCityList as $id => $city_id) {
				$col++;
				$output = "";
				if (array_key_exists($city_id, $dateValues)) {
					if ($dateValues[$city_id] != "null") {
						if ($show_percent === false) {
							if (in_array($columnLetter, array("J","K"))) {
								$output = $wgLang->formatNum(sprintf("%0.1f", 100 * $dateValues[$city_id]));
							} else {
								$output = $wgLang->formatNum(sprintf("%0.1f", $dateValues[$city_id]));
							}
						} else {
							$output = sprintf("%0.0f%%", $dateValues[$city_id]);
						}
					}
				}
				#---
				if (is_numeric($output))
					$this->writeXLSNumber($row, $col, $output);
				else
					$this->writeXLSLabel($row, $col, $output);
			}
			#---
			$prev_date = $cur_date;
		}

		unset($cityList);
		unset($splitCityList);
		unset($columnHistory);
		unset($columnRange);
		$this->setXLSFileEnd();
	}

	public function makeWikiaActivity($params)	{
		$this->setXLSHeader();

		#----
		$this->setXLSFileBegin();

		$col = 1;
		$this->writeXLSLabel(1, $col, wfMsg("wikistats_active_useredits"));
		#lang
		$this->writeXLSLabel(2, $col, wfMsg('wikistats_wikilang'));
		$this->writeXLSLabel(2, $col+1, @$params['lang']);
		#category
		$col = 1;
		$this->writeXLSLabel(3, $col, wfMsg('wikistats_wikicategory'));
		$this->writeXLSLabel(3, $col+1, @$params['cat']);
		#date
		$col = 1;
		$this->writeXLSLabel(4, $col, wfMsg('wikistats_date'));
		$this->writeXLSLabel(4, $col+1, @$params['year']);
		$this->writeXLSLabel(4, $col+2, @$params['month']);

		$col = 1;
		$this->writeXLSLabel(5, $col, '#');
		$this->writeXLSLabel(5, $col+1, wfMsg('wikistats_database'));
		$this->writeXLSLabel(5, $col+2,wfMsg('wikistats_title'));
		$this->writeXLSLabel(5, $col+3,wfMsg('wikistats_wikiurl'));
		$this->writeXLSLabel(5, $col+4,wfMsg('wikistats_unique_users'));
		$this->writeXLSLabel(5, $col+5,wfMsg('wikistats_edits'));
		$this->writeXLSLabel(5, $col+6,wfMsg('wikistats_articles_text'));
		$this->writeXLSLabel(5, $col+7,wfMsg('wikistats_last_edit'));

		$row = 6;
		foreach ($this->mData as $city_id => $columns) {
			$row++;
			$col = 1;
			foreach ( $columns as $id => $value ) {
				if ( $id > 7 ) continue;
				if (is_numeric($value)) {
					$this->writeXLSNumber($row, $col, $value);
				} else {
					$this->writeXLSLabel($row,$col,$value);
				}
				$col++;
			}
		}

		$this->setXLSFileEnd();
	}

	public function makeNamespaceStats($tableTitle) {
		global $wgUser, $wgLang, $wgContLang;

		#----
		$this->setXLSHeader();
		#----
		$this->setXLSFileBegin();
		$this->writeXLSLabel(1,1,wfMsg('wikistats_ns_statistics_legend'));
		$this->mergeXLSColsRows(1, 1, 1, count($tableTitle));
		/*
		 * table header
		 */
		$this->writeXLSLabel( 3 /*row*/, 1 /*column*/, wfMsg('wikistats_date') );
		$this->mergeXLSColsRows( 3, 1, 4, 1 );
		$i = 2;
		foreach ( $tableTitle as $ns => $value ) {
			$this->writeXLSLabel( 3 /*row*/, $i /*column*/, $value );
			$this->mergeXLSColsRows( 3, $i, 3, $i+2 );
			$i = $i+3;
		}

		$i = 2;
		foreach ( $tableTitle as $ns => $value ) {
			$this->writeXLSLabel( 4 /*row*/, $i /*column*/, wfMsg('wikistats_total') );
			$i++;
			$this->writeXLSLabel( 4 /*row*/, $i /*column*/, str_replace('<br />', ' ', wfMsg('wikistats_new_per_day')) );
			$i++;
			$this->writeXLSLabel( 4 /*row*/, $i /*column*/, wfMsg('wikistats_edits') );
			$i++;
		}

		$k = 5;
		foreach ($this->mData as $date => $columns) {
			$i = 1;
			$stamp = mktime(23, 59, 59, substr($date, 4, 2), 1, substr($date, 0, 4));
			$out = $wgLang->sprintfDate("M Y", wfTimestamp(TS_MW, $stamp));

			$this->writeXLSLabel( $k /*row*/, $i /*column*/, $out );

			foreach ( $tableTitle as $ns => $value ) {
				if ( !isset( $columns[$ns] ) ) {
					foreach ( array('A','B','C') as $c ) {
						$columns[$ns][$c] = 0;
					}
				}
				foreach ( $columns[$ns] as $column => $out ) {
					if ( $column == 'date' ) continue;
					$i++;
					if (empty($out) || ($out === 0)) {
						$out = "";
					} else {
						$out = $wgContLang->formatNum($out);
					}
					$cols[] = $column;
					$this->writeXLSLabel( $k /*row*/, $i /*column*/, $out );
				}
			}
			$k++;
		}

		$this->setXLSFileEnd();
	}
}
