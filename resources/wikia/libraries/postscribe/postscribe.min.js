/* Asynchronously write javascript, even with document.write., v1.1.2 https://github.com/krux/postscribe
Copyright (c) 2013 Derek Brans, MIT license https://github.com/krux/postscribe/blob/master/LICENSE */
(function(){function o(o,u){o=o||"",u=u||{};for(var a in e)e.hasOwnProperty(a)&&(u.autoFix&&(u["fix_"+a]=!0),u.fix=u.fix||u["fix_"+a]);var f=[],l=function(e){o+=e},c=function(e){o=e+o},h={comment:/^<!--/,endTag:/^<\//,atomicTag:/^<\s*(script|style|noscript|iframe|textarea)[\s>]/i,startTag:/^</,chars:/^[^<]/},p={comment:function(){var e=o.indexOf("-->");if(e>=0)return{content:o.substr(4,e),length:e+3}},endTag:function(){var e=o.match(n);if(e)return{tagName:e[1],length:e[0].length}},atomicTag:function(){var e=p.startTag();if(e){var t=o.slice(e.length);if(t.match(new RegExp("</\\s*"+e.tagName+"\\s*>","i"))){var n=t.match(new RegExp("([\\s\\S]*?)</\\s*"+e.tagName+"\\s*>","i"));if(n)return{tagName:e.tagName,attrs:e.attrs,content:n[1],length:n[0].length+e.length}}}},startTag:function(){var e=o.match(t);if(e){var n={};return e[2].replace(r,function(e,t){var r=arguments[2]||arguments[3]||arguments[4]||i.test(t)&&t||null;n[t]=r}),{tagName:e[1],attrs:n,unary:!!e[3],length:e[0].length}}},chars:function(){var e=o.indexOf("<");return{length:e>=0?e:o.length}}},d=function(){for(var e in h)if(h[e].test(o)){s&&console.log("suspected "+e);var t=p[e]();return t?(s&&console.log("parsed "+e,t),t.type=t.type||e,t.text=o.substr(0,t.length),o=o.slice(t.length),t):null}},v=function(e){var t;while(t=d())if(e[t.type]&&e[t.type](t)===!1)return},m=function(){var e=o;return o="",e},g=function(){return o};return u.fix&&function(){var e=/^(AREA|BASE|BASEFONT|BR|COL|FRAME|HR|IMG|INPUT|ISINDEX|LINK|META|PARAM|EMBED)$/i,t=/^(COLGROUP|DD|DT|LI|OPTIONS|P|TD|TFOOT|TH|THEAD|TR)$/i,n=[];n.last=function(){return this[this.length-1]},n.lastTagNameEq=function(e){var t=this.last();return t&&t.tagName&&t.tagName.toUpperCase()===e.toUpperCase()},n.containsTagName=function(e){for(var t=0,n;n=this[t];t++)if(n.tagName===e)return!0;return!1};var r=function(t){return t&&t.type==="startTag"&&(t.unary=e.test(t.tagName)||t.unary),t},i=d,s=function(){var e=o,t=r(i());return o=e,t},a=function(){var e=n.pop();c("</"+e.tagName+">")},f={startTag:function(e){var r=e.tagName;r.toUpperCase()==="TR"&&n.lastTagNameEq("TABLE")?(c("<TBODY>"),h()):u.fix_selfClose&&t.test(r)&&n.containsTagName(r)?n.lastTagNameEq(r)?a():(c("</"+e.tagName+">"),h()):e.unary||n.push(e)},endTag:function(e){var t=n.last();t?u.fix_tagSoup&&!n.lastTagNameEq(e.tagName)?a():n.pop():u.fix_tagSoup&&l()}},l=function(){i(),h()},h=function(){var e=s();e&&f[e.type]&&f[e.type](e)};d=function(){return h(),r(i())}}(),{append:l,readToken:d,readTokens:v,clear:m,rest:g,stack:f}}var e=function(){var e={},t,n=this.document.createElement("div");return t="<P><I></P></I>",n.innerHTML=t,e.tagSoup=n.innerHTML!==t,n.innerHTML="<P><i><P></P></i></P>",e.selfClose=n.childNodes.length===2,e}(),t=/^<([\-A-Za-z0-9_]+)((?:\s+[\w\-]+(?:\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|[^>\s]+))?)*)\s*(\/?)>/,n=/^<\/([\-A-Za-z0-9_]+)[^>]*>/,r=/([\-A-Za-z0-9_]+)(?:\s*=\s*(?:(?:"((?:\\.|[^"])*)")|(?:'((?:\\.|[^'])*)')|([^>\s]+)))?/g,i=/^(checked|compact|declare|defer|disabled|ismap|multiple|nohref|noresize|noshade|nowrap|readonly|selected)$/i,s=!1;o.supports=e,o.tokenToString=function(e){var t={comment:function(e){return"<--"+e.content+"-->"},endTag:function(e){return"</"+e.tagName+">"},atomicTag:function(e){return console.log(e),t.startTag(e)+e.content+t.endTag(e)},startTag:function(e){var t="<"+e.tagName;for(var n in e.attrs){var r=e.attrs[n];t+=" "+n+'="'+(r?r.replace(/(^|[^\\])"/g,'$1\\"'):"")+'"'}return t+(e.unary?"/>":">")},chars:function(e){return e.text}};return t[e.type](e)},o.escapeAttributes=function(e){var t={};for(var n in e){var r=e[n];t[n]=r&&r.replace(/(^|[^\\])"/g,'$1\\"')}return t};for(var u in e)o.browserHasFlaw=o.browserHasFlaw||!e[u]&&u;this.htmlParser=o})(),function(){function i(){}function s(e){return"function"==typeof e}function o(e,t,n){var r,i=e&&e.length||0;for(r=0;r<i;r++)t.call(n,e[r],r)}function u(e,t,n){var r;for(r in e)e.hasOwnProperty(r)&&t.call(n,r,e[r])}function a(e,t){return u(t,function(t,n){e[t]=n}),e}function f(e,t){return e=e||{},u(t,function(t,n){e[t]==null&&(e[t]=n)}),e}function l(e){try{return r.call(e)}catch(t){var n=[];return o(e,function(e){n.push(e)}),n}}function c(e){return/^script$/i.test(e.tagName)}var e=this;if(e.postscribe)return;var t=!0,n=!1,r=Array.prototype.slice,h=function(){function r(e,n,r){var i=t+n;if(arguments.length===2){var s=e.getAttribute(i);return s==null?s:String(s)}r!=null&&r!==""?e.setAttribute(i,r):e.removeAttribute(i)}function i(t,n){var i=t.ownerDocument;a(this,{root:t,options:n,win:i.defaultView||i.parentWindow,doc:i,parser:e.htmlParser("",{autoFix:!0}),actuals:[t],proxyHistory:"",proxyRoot:i.createElement(t.nodeName),scriptStack:[],writeQueue:[]}),r(this.proxyRoot,"proxyof",0)}var t="data-ps-";return i.prototype.write=function(){[].push.apply(this.writeQueue,arguments);var e;while(!this.deferredRemote&&this.writeQueue.length)e=this.writeQueue.shift(),s(e)?this.callFunction(e):this.writeImpl(e)},i.prototype.callFunction=function(e){var t={type:"function",value:e.name||e.toString()};this.onScriptStart(t),e.call(this.win,this.doc),this.onScriptDone(t)},i.prototype.writeImpl=function(e){this.parser.append(e);var t,n=[];while((t=this.parser.readToken())&&!c(t))n.push(t);this.writeStaticTokens(n),t&&this.handleScriptToken(t)},i.prototype.writeStaticTokens=function(e){var t=this.buildChunk(e);if(!t.actual)return;return t.html=this.proxyHistory+t.actual,this.proxyHistory+=t.proxy,this.proxyRoot.innerHTML=t.html,n&&(t.proxyInnerHTML=this.proxyRoot.innerHTML),this.walkChunk(),n&&(t.actualInnerHTML=this.root.innerHTML),t},i.prototype.buildChunk=function(e){var n=this.actuals.length,r=[],i=[],s=[];return o(e,function(e){r.push(e.text);if(e.attrs){if(!/^noscript$/i.test(e.tagName)){var o=n++;i.push(e.text.replace(/(\/?>)/," "+t+"id="+o+" $1")),e.attrs.id!=="ps-script"&&s.push(e.type==="atomicTag"?"":"<"+e.tagName+" "+t+"proxyof="+o+(e.unary?"/>":">"))}}else i.push(e.text),s.push(e.type==="endTag"?e.text:"")}),{tokens:e,raw:r.join(""),actual:i.join(""),proxy:s.join("")}},i.prototype.walkChunk=function(){var e,t=[this.proxyRoot];while((e=t.shift())!=null){var n=e.nodeType===1,i=n&&r(e,"proxyof");if(!i){n&&(this.actuals[r(e,"id")]=e,r(e,"id",null));var s=e.parentNode&&r(e.parentNode,"proxyof");s&&this.actuals[s].appendChild(e)}t.unshift.apply(t,l(e.childNodes))}},i.prototype.handleScriptToken=function(e){var t=this.parser.clear();t&&this.writeQueue.unshift(t),e.src=e.attrs.src||e.attrs.SRC,e.src&&this.scriptStack.length?this.deferredRemote=e:this.onScriptStart(e);var n=this;this.writeScriptToken(e,function(){n.onScriptDone(e)})},i.prototype.onScriptStart=function(e){e.outerWrites=this.writeQueue,this.writeQueue=[],this.scriptStack.unshift(e)},i.prototype.onScriptDone=function(e){if(e!==this.scriptStack[0]){this.options.error({message:"Bad script nesting or script finished twice"});return}this.scriptStack.shift(),this.write.apply(this,e.outerWrites),!this.scriptStack.length&&this.deferredRemote&&(this.onScriptStart(this.deferredRemote),this.deferredRemote=null)},i.prototype.writeScriptToken=function(e,t){var n=this.buildScript(e);e.src&&(n.src=e.src,this.scriptLoadHandler(n,t));try{this.insertScript(n),e.src||t()}catch(r){this.options.error(r),t()}},i.prototype.buildScript=function(e){var t=this.doc.createElement(e.tagName);return u(e.attrs,function(e,n){t.setAttribute(e,n)}),e.content&&(t.text=e.content),t},i.prototype.insertScript=function(e){this.writeImpl('<span id="ps-script"/>');var t=this.doc.getElementById("ps-script");t.parentNode.replaceChild(e,t)},i.prototype.scriptLoadHandler=function(e,t){function n(){e=e.onload=e.onreadystatechange=e.onerror=null,t()}var r=this.options.error;a(e,{onload:function(){n()},onreadystatechange:function(){/^(loaded|complete)$/.test(e.readyState)&&n()},onerror:function(){r({message:"remote script failed "+e.src}),n()}})},i}(),p=function(){function o(){var e=n.shift();e&&(e.stream=u.apply(null,e))}function u(e,n,s){function c(e){e=s.beforeWrite(e),r.write(e),s.afterWrite(e)}r=new h(e,s),r.id=t++,r.name=s.name||r.id,l.streams[r.name]=r;var u=e.ownerDocument,f={write:u.write,writeln:u.writeln};a(u,{write:c,writeln:function(e){c(e+"\n")}});var p=r.win.onerror||i;return r.win.onerror=function(e,t,n){s.error({msg:e+" - "+t+":"+n}),p.apply(r.win,arguments)},r.write(n,function(){a(u,f),r.win.onerror=p,s.done(),r=null,o()}),r}function l(t,u,a){s(a)&&(a={done:a}),a=f(a,{done:i,error:function(e){throw e},beforeWrite:function(e){return e},afterWrite:i}),t=/^#/.test(t)?e.document.getElementById(t.substr(1)):t.jquery?t[0]:t;var l=[t,u,a];return t.postscribe={cancel:function(){l.stream?l.stream.abort():l[1]=i}},n.push(l),r||o(),t.postscribe}var t=0,n=[],r=null;return a(l,{streams:{},queue:n,WriteStream:h})}();e.postscribe=p}();